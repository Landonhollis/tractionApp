# DATA PRODUCT REQUIREMENT DOCUMENT

## Core Entities

### accounts
User account information and preferences.

**Fields:**
- id: uuid (primary key, default: gen_random_uuid())
- user_id: uuid (required, unique, FK -> auth.users.id)
- theme_name: text (nullable, stores user's selected theme)
- created_at: timestamptz (default: now())
- updated_at: timestamptz (default: now())

**RLS Policies:**
- Enable RLS on the accounts table
- SELECT: Users can only read their own account (user_id = auth.uid())
- UPDATE: Users can only update their own account (user_id = auth.uid())
- INSERT: Service role only (handled by database trigger)
- DELETE: Service role only

**Database Trigger:**
- Function: create_user_account_on_signup()
- Trigger: on_auth_user_created
- Event: AFTER INSERT on auth.users
- Action: Creates a record in accounts table with user_id set to new user's id and theme_name set to null

**Relationships:**
- accounts.user_id → auth.users.id (one-to-one) 

## Authentication & User Management

**Supabase Auth (READ-ONLY):**
- auth.users table is managed by Supabase and cannot be modified
- Contains: id (uuid), email, encrypted_password, created_at, etc.
- Used ONLY for authentication, not application data
- but the id from this table can be used on other tables. 

## SCREEN-GENERATED SCHEMAS
[Screen agents will append their data schemas below this line]

---

### AUTH SCREEN SCHEMA

**Generated by:** Auth Screen Implementation
**Date:** 2025-10-24

#### Authentication Flow Data Requirements

The authentication screen uses Supabase Auth's built-in `auth.users` table (read-only) and extends it with the `accounts` table for app-specific user data.

```json
{
  "$schema": "auth",
  "title": "users (read-only)",
  "type": "object",
  "description": "Supabase Auth managed table. Contains core authentication data.",
  "properties": {
    "id": {
      "type": "string",
      "format": "uuid",
      "purpose": "primary key",
      "owner": "system",
      "description": "Unique user identifier, auto-generated by Supabase Auth"
    },
    "email": {
      "type": "string",
      "format": "email",
      "purpose": "authentication identifier",
      "owner": "user",
      "description": "User's email address for authentication",
      "validation": "Must be valid email format"
    },
    "encrypted_password": {
      "type": "string",
      "purpose": "authentication credential",
      "owner": "system",
      "description": "Bcrypt hashed password (never exposed to client)",
      "security": "Hashed using bcrypt, minimum 6 characters required"
    },
    "email_confirmed_at": {
      "type": "string",
      "format": "timestamptz",
      "purpose": "email verification status",
      "owner": "system",
      "description": "Timestamp when email was verified, null if unverified"
    },
    "created_at": {
      "type": "string",
      "format": "timestamptz",
      "purpose": "audit trail",
      "owner": "system",
      "description": "Account creation timestamp"
    },
    "last_sign_in_at": {
      "type": "string",
      "format": "timestamptz",
      "purpose": "activity tracking",
      "owner": "system",
      "description": "Last successful sign in timestamp"
    },
    "raw_user_meta_data": {
      "type": "object",
      "format": "jsonb",
      "purpose": "user-editable metadata",
      "owner": "user",
      "description": "Non-sensitive user metadata that user can update"
    },
    "raw_app_meta_data": {
      "type": "object",
      "format": "jsonb",
      "purpose": "app-managed metadata",
      "owner": "system",
      "description": "App metadata that user cannot update (e.g., roles, permissions)"
    }
  },
  "required": ["id", "email"],
  "rls_policies": {
    "note": "Managed by Supabase Auth, not directly accessible via RLS"
  },
  "relationships": {
    "accounts": "auth.users.id → accounts.user_id (one-to-one)",
    "identities": "auth.users.id → auth.identities.user_id (one-to-many)"
  }
}
```

```json
{
  "$schema": "public",
  "title": "accounts",
  "type": "object",
  "description": "App-specific user account data and preferences. Automatically created on user signup via database trigger.",
  "properties": {
    "id": {
      "type": "string",
      "format": "uuid",
      "purpose": "primary key",
      "owner": "system",
      "description": "Unique account identifier",
      "default": "gen_random_uuid()"
    },
    "user_id": {
      "type": "string",
      "format": "uuid",
      "purpose": "foreign key to auth.users",
      "owner": "system",
      "description": "References auth.users.id, unique and required",
      "constraints": "UNIQUE, NOT NULL, ON DELETE CASCADE"
    },
    "theme_name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 50,
      "purpose": "user preference",
      "owner": "user",
      "description": "User's selected theme (e.g., 'theme1', 'theme2')",
      "default": "null",
      "enum": ["theme1", "theme2", "theme3", "theme4", "theme5"]
    },
    "created_at": {
      "type": "string",
      "format": "timestamptz",
      "purpose": "audit trail",
      "owner": "system",
      "description": "Account record creation timestamp",
      "default": "now()"
    },
    "updated_at": {
      "type": "string",
      "format": "timestamptz",
      "purpose": "audit trail",
      "owner": "system",
      "description": "Last update timestamp, auto-updated on changes",
      "default": "now()"
    }
  },
  "required": ["id", "user_id", "created_at", "updated_at"],
  "rls_policies": {
    "select": "auth.uid() = user_id",
    "update": "auth.uid() = user_id",
    "insert": "Service role only (via trigger)",
    "delete": "Service role only"
  },
  "triggers": {
    "on_auth_user_created": {
      "event": "AFTER INSERT on auth.users",
      "function": "create_account_for_new_user()",
      "description": "Automatically creates account record when new user signs up"
    },
    "update_accounts_updated_at": {
      "event": "BEFORE UPDATE on accounts",
      "function": "update_updated_at_column()",
      "description": "Automatically updates updated_at timestamp on row changes"
    }
  },
  "relationships": {
    "users": "accounts.user_id → auth.users.id (one-to-one)"
  }
}
```

#### Authentication Service Methods

The auth screen uses the following service methods from `/services/authServices.ts`:

1. **signUpWithEmail(email, password)** - Creates new user account using Supabase Auth
2. **signInWithEmail(email, password)** - Authenticates existing user
3. **signInWithGoogle()** - Initiates Google OAuth flow (requires Google provider setup in Supabase dashboard)
4. **createUserAccount(userId)** - Creates account record (called automatically by trigger, but also used by AccountProvider)
5. **signOut()** - Signs out current user
6. **requestPasswordReset(email)** - Sends password reset email
7. **getSession()** - Retrieves current session
8. **getUser()** - Retrieves current user

#### Password Requirements

- Minimum length: 6 characters
- Stored as bcrypt hash in auth.users.encrypted_password
- Password validation occurs client-side and server-side (Supabase Auth)

#### Email Validation

- Format: Standard email regex `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`
- Email confirmation can be enabled/disabled in Supabase dashboard
- Confirmation emails sent via Supabase's email service or custom SMTP

#### OAuth Providers

Currently configured for Google OAuth:
- Requires setup in Supabase dashboard (Auth > Providers > Google)
- Requires Google OAuth client ID and secret
- Redirect URLs must be configured in both Google Console and Supabase

#### Session Management

- Sessions managed automatically by Supabase Auth
- Stored in AsyncStorage (React Native)
- Auto-refresh enabled
- Session persistence enabled
- AccountProvider monitors auth state changes

#### Security Considerations

1. **Password Security:**
   - Passwords hashed using bcrypt
   - Never stored in plaintext
   - Minimum 6 character requirement

2. **RLS Policies:**
   - Users can only access their own account data
   - Account creation restricted to trigger (prevents manual creation)
   - No DELETE policy for users (prevents accidental account deletion)

3. **Email Verification:**
   - Optional email confirmation flow
   - Configurable in Supabase dashboard
   - Recommended for production

4. **OAuth Security:**
   - Uses PKCE flow for enhanced security
   - State parameter prevents CSRF attacks
   - Redirect URLs must be whitelisted